# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript
trigger:
  branches:
    include:
    - refs/heads/ci-cd
resources:
  repositories:
  - repository: self
    type: git
    ref: refs/heads/ci-cd

stages:
  - stage: build
    displayName: "Build"
    jobs:
      - job: build_test
        displayName: "Build"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: NodeTool@0
            inputs:
              versionSource: 'spec'
              versionSpec: '18.x'
            displayName: "Install Node.js"

          - task: npmAuthenticate@0
            inputs:
              workingFile: .npmrc
            displayName: "Authenticate with Azure Artifacts"

          - task: Bash@3
            displayName: "Install Node Packages"
            inputs:
              targetType: 'inline'
              script: 'npm i navi-web --force'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
          
          - task: Bash@3
            displayName: "Create Build"
            inputs:
              targetType: 'inline'
              script: 'npm run build:dev'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
        
          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/dist/xnode'
              includeRootFolder: true
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
              replaceExistingArchive: true
              
          - task: PublishPipelineArtifact@1
            displayName: "Publish Build Artifacts"
            inputs:
              path: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
              artifact: 'drop'

