<div class="cr-tabs-div">
  <xnode-no-comments *ngIf="crData?.length === 0" [content]="'No open CRs yet'"></xnode-no-comments>
  <div *ngIf="crData?.length > 0">
    <div class="h-3rem p-0 m-0 w-full submit-cr-window grid align-items-center px-4 justify-content-between"
      *ngIf="checkedCrList?.length > 0">
      <div class="p-0 m-0 flex col-5">
        <img src="../../assets/checkbox.svg" class="" alt="high" />
        <p class="text-xs ml-2 text-white">
          {{ checkedCrList?.length }}/{{ crData?.length }} items selected
        </p>
      </div>
      <div class="p-0 m-0 flex justify-content-between col-7 align-items-center">
        <img src="../../assets/archive.svg" class="submit-cr-window-icon" alt="archive"
          (click)="updateChagneRequestStatus('ARCHIVE')" />
        <img src="../../assets/newuser.svg" class="submit-cr-window-icon" alt="adduser" />
        <img src="../../assets/status.svg" class="submit-cr-window-icon" alt="status" />
        <img src="../../assets/calender.svg" class="submit-cr-window-icon" alt="calender" />
        <img src="../../assets/link-cr.svg" class="submit-cr-window-icon" alt="link"
          (click)="updateChagneRequestStatus('UNLINK')" />
        <p-button label="Update Spec" [rounded]="true" (click)="onClickUpdateSpec()"
          [disabled]="checkedCrList?.length ===0"></p-button>
      </div>
    </div>
    <div class="flex align-items-center justify-content-between w-full pt-2 pl-4 pr-4">
      <div class="flex align-items-center">
        <p-dropdown formControlName="product" [options]="filters" placeholder="Filter: All" optionLabel="title"
          class="custom-dropdown" [filter]="true" filterBy="title" filterPlaceholder="Search">
          <ng-template let-item pTemplate="item">
            <div class="col-12 flex align-items-center justify-content-between">
              <div class="title-container" [title]="item.title">
                {{ item.title }}
              </div>
            </div>
          </ng-template>
        </p-dropdown>
        <p-button label="Create New" styleClass="p-button-sm p-button-secondary" [rounded]="true" class="ml-2"
          (click)="createNewCr()"></p-button>
      </div>
      <div>
        <i class="pi pi-search text-base mx-1 light-grey"></i>
        <i class="pi pi-user text-base mx-1 light-grey"></i>
      </div>
    </div>
    <div class="flex pl-4 pr-4 justify-content-between align-items-center p-0 h-4rem">
      <div class="">
        <p class="flex align-items-center text-base light-grey text-sm"
          *ngIf="sortColumn === 'dueDate' && sortDirection === 'desc'">Today</p>
      </div>
      <div class="flex align-items-center p-0 pointer" (click)="sortCrList('dueDate')">
        <i class="pi pi-arrow-up text-base mx-1 text-gray-200"
          *ngIf="sortColumn === 'dueDate' && sortDirection === 'desc'"></i>
        <i class="pi pi-arrow-down text-base mx-1 text-gray-200"
          *ngIf="sortColumn === 'dueDate' && sortDirection === 'asc'"></i>
        <p class="my-0 text-gray-200 text-sm">Date Created</p>
      </div>
    </div>
    <div>
      <div class="w-full pl-4 pr-4">
        <p-accordion class="cr-tabs" [multiple]="true" *ngFor="let data of crData;let i = index"
          (onOpen)="onAccordionOpen(data,i)">
          <p-accordionTab class="border-bottom-1 accordian mt-4">
            <ng-template pTemplate="header">
              <div class="w-full">
                <div class="grid col-12 flex-column">
                  <p-checkbox (onChange)="onCheckCheckbox($event)" [binary]="true" inputId="binary"
                    [(ngModel)]="data.checked" *ngIf="data.status ==='DRAFT'"></p-checkbox>
                  <div class="flex flex-row align-items-center" style="position: absolute; margin-left: 13%">
                    <img src="../../assets/high.svg" class="" alt="high" />
                    <p class="p-0 m-0 text-xs ml-2">
                      <a href="" class="text-primary-500"># {{ data.crId }}</a>
                      <a href="" class="text-primary-500 ml-2" *ngIf="data.status !=='DRAFT'"
                        (click)="onClickViewChanges(data)">View Changes</a>
                    </p>
                  </div>
                  <div class="w-full pl-7" [ngClass]="{'mt-3': data.status !=='DRAFT'}">
                    <div class="flex align-items-center justify-content-between">
                      <div class="flex">
                        <img src="../../assets/todo.svg" alt="todo" />
                        <div class="flex align-items-center">
                          <p class="text-sm half-white pl-2">{{ data?.title }}</p>
                          <div [ngClass]="{
                          'border-green-500': data.status === 'SUBMITTED' || data.status === 'APPROVED',
                          'border-red-500': data.status === 'ARCHIVED' || data.status === 'REJECTED',
                          'border-orange-500': data.status === 'UPDATED' || data.status ==='REVIEWED' || data.status ==='NEEDS_WORK',
                          'border-yellow-500': data.status === 'DRAFT',
                          }" class="ml-2 flex align-items-center border-1 pl-2 pr-2 border-round-2xl">
                            <div class="border-circle text-xs">
                              <ng-container *ngIf="data.status === 'SUBMITTED'">
                                <i class="pi pi-circle-fill text-green-500"></i>
                              </ng-container>
                              <ng-container *ngIf="data.status === 'ARCHIVED' || data.status === 'REJECTED'">
                                <i class="pi pi-times-circle text-red-500"></i>
                              </ng-container>
                              <ng-container
                                *ngIf="data.status === 'UPDATED' || data.status ==='REVIEWED' || data.status ==='NEEDS_WORK'">
                                <i class="pi pi-check-circle text-orange-500"></i>
                              </ng-container>
                              <ng-container *ngIf="data.status === 'DRAFT'">
                                <i class="pi pi-clock text-yellow-500"></i>
                              </ng-container>
                            </div>
                            <div class="text-xs ml-2" [ngClass]="{
                              'text-green-500': data.status === 'SUBMITTED' || data.status === 'APPROVED',
                              'text-red-500': data.status === 'ARCHIVED' || data.status === 'REJECTED',
                              'text-orange-500': data.status === 'UPDATED' || data.status ==='REVIEWED' || data.status ==='NEEDS_WORK' ,
                              'text-yellow-500': data.status == 'DRAFT'
                            }">{{data.status | uppercase}}
                            </div>
                          </div>
                        </div>
                      </div>
                      <i class="pi pi-ellipsis-v text-base mx-1 text-gray-200"
                        *ngIf="data.status !== 'SUBMITTED' || data.status !== 'ARCHIVED'" (click)="
                      op.toggle($event);
                      updateSelectedCr(data);
                      $event.stopPropagation();
                      getMeActions(data)
                    "></i>

                    </div>
                    <div class="flex align-items-center pl-4" style="margin-top: -15px">
                      <p class="text-xs shaded-color normal-font-weight">
                        Due by : {{data.duedate | date}}
                      </p>
                      <img src="../../assets/Group.svg" class="ml-4" alt="CR" />
                      <span class="shaded-color ml-1 normal-font-weight">3</span>
                    </div>
                  </div>
                  <div class="card m-0 p-0 mb-2" *ngIf="data.showComment" (click)="$event.stopPropagation()">
                    <xnode-add-comment-overlay-panel [users]="usersList" [from]="'cr-tabs'"
                      placeHolder="Reason for your actions" [component]="'crTabs'"
                      (commentInfo)="updateCommentsInfo($event)"></xnode-add-comment-overlay-panel>
                  </div>
                </div>
              </div>
            </ng-template>

            <ng-template pTemplate="content">
              <div class="pl-7 pr-4">
                <div class="card m-0 p-0 mb-2" *ngIf="showComment">
                  <xnode-add-comment-overlay-panel [users]="usersList" [from]="'cr-tabs'"
                    placeHolder="Reason for your actions" [component]="'crTabs'"
                    (commentInfo)="updateCommentsInfo($event)"></xnode-add-comment-overlay-panel>
                </div>
                <div class="border-bottom-1 pt-2" *ngFor="let subData of crList?.[i]; ">
                  <span *ngIf="subData.task else commentSpan">
                    <div class="flex flex-row justify-content-between align-items-center w-full">
                      <div class="w-full flex justify-content-between align-items-center">
                        <p class="my-0 text-gray-200 text-sm font-normal">
                          {{ subData?.task?.referenceContent?.title }}
                        </p>
                        <div class="flex align-items-center ">
                          <div class="text-xs mr-2 text-orange-500">{{subData.status}}</div>
                          <span *ngFor="let reviewers of data?.reviewers">
                            <p-avatar [label]="getMeUserAvatar(reviewers)" class="text-xs" shape="circle" [style]="{
                              'background-color': '#9c27b0',
                              color: '#ffffff', fontSize: '10px'
                            }"></p-avatar>
                          </span>
                          <i class="pi pi-ellipsis-v text-base mx-1 text-gray-200"
                            (click)="op.toggle($event); $event.stopPropagation()"></i>
                        </div>
                      </div>
                    </div>
                    <div class="py-2 border-bottom-1 pr-4">
                      <div class="flex flex-row justify-content-between">
                        <div class="sctions-grid w-full">
                          <div *ngIf="checktableJsonSection(subData?.task?.referenceContent?.title) else normalView">
                            <pre *ngIf="!subData?.task?.referenceContent?.showTable"
                              [innerHTML]="subData?.task?.referenceContent?.content | json"
                              style=" white-space: pre-wrap; overflow: auto"></pre>
                            <xnode-common-spec-table *ngIf="subData?.task?.referenceContent?.showTable"
                              [specItem]="subData?.task?.referenceContent?.content?.content"
                              [content]="subData?.task?.referenceContent?.content"></xnode-common-spec-table>
                          </div>
                          <ng-template #normalView>

                            <div
                              *ngIf="checkParaViewSections(subData?.task?.referenceContent?.title,subData?.task?.referenceContent?.parentTitle)"
                              class="h-auto">
                              <xnode-para-view [showComments]="false"
                                [content]="subData?.task?.referenceContent?.content"
                                [searchTerm]="subData?.task?.referenceContent?.commentedtext" [users]="usersList"
                                [specItem]="subData?.task?.referenceContent?.content"
                                [id]="subData?.task?.referenceContent?.id"></xnode-para-view>
                            </div>
                            <div *ngIf="checkListViewSections(subData?.task?.referenceContent?.parentTitle)"
                              class="h-auto">
                              <xnode-list-view [content]="subData?.task?.referenceContent"
                                [searchTerm]="subData?.task?.referenceContent?.commentedtext"
                                [users]="usersList"></xnode-list-view>
                            </div>
                            <div *ngIf="checkUserRoleSections(subData?.task?.referenceContent?.parentTitle)"
                              class="h-auto">
                              <xnode-user-roles [searchTerm]="subData?.task?.referenceContent?.commentedtext"
                                [content]="subData?.task?.referenceContent" [users]="usersList"
                                [specItem]="subData?.task?.referenceContent?.content"></xnode-user-roles>
                            </div>
                            <div *ngIf="checkUserPersonaSections(subData?.task?.referenceContent?.title)"
                              class="h-auto">
                              <xnode-user-persona [searchTerm]="subData?.task?.referenceContent?.commentedtext"
                                [content]="subData?.task?.referenceContent?.content"></xnode-user-persona>
                            </div>
                            <div *ngIf="subData?.task?.referenceContent.title === 'Dashboards'">
                              <div class="flex justify-content-between align-items-center">
                                <h1 class="my-1">Dashboard</h1>
                              </div>
                              <div class="grid">
                                <iframe id="myIframe" [src]="iframeSrc" class="h-vh w-full" title="Template Builder">
                                </iframe>
                              </div>
                            </div>
                            <div
                              *ngIf="subData?.task?.referenceContent?.title=='Data Quality Checks' || subData?.task?.referenceContent?.title=='Historical Data Load'|| subData?.task?.referenceContent?.title == 'Version Control'|| subData?.task?.referenceContent?.title == 'Stakeholder Approvals' || subData?.task?.referenceContent?.title=='Glossary'">
                              <xnode-common-spec-table [users]="usersList"
                                [searchTerm]="subData?.task?.referenceContent?.commentedtext"
                                [content]="subData?.task?.referenceContent?.content"></xnode-common-spec-table>
                            </div>
                            <div *ngIf="subData?.task?.referenceContent?.title=='Test Cases'">
                              <div *ngFor="let itemuc of subData?.task?.referenceContent?.content">
                                <div class="mt-2">
                                  <h3>
                                    {{itemuc.Usecase}}
                                  </h3>
                                  <div class="mt-2">
                                    <xnode-common-spec-table
                                      [searchTerm]="subData?.task?.referenceContent?.commentedtext" [users]="usersList"
                                      [content]="itemuc.TestCases"></xnode-common-spec-table>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div *ngIf="subData?.task?.referenceContent?.title==='Workflows'">
                              <xnode-bpmn-common [bpmnFrom]="bpmnFrom" [referenceId]="subData?.task?.id"
                                [item]="subData?.task?.referenceContent"></xnode-bpmn-common>
                            </div>
                            <div *ngIf="subData?.task?.referenceContent?.title==='Data Model'">
                              <xnode-data-model-common
                                [dataModelData]="subData?.task?.referenceContent"></xnode-data-model-common>
                            </div>
                            <div
                              *ngIf="subData?.task?.referenceContent?.title === 'Usecases' || subData?.task?.referenceContent?.title === 'Use Cases'">
                              <xnode-common-usecases [searchTerm]="subData?.task?.referenceContent?.commentedtext"
                                [users]="usersList"
                                [useCases]="subData?.task?.referenceContent.content"></xnode-common-usecases>
                            </div>
                            <div *ngIf="subData?.task?.referenceContent.title === 'OpenAPI Spec'">
                              <div class="flex col-12 justify-content-between align-items-center">
                                <h4 class="m-0">Swagger API</h4>
                              </div>
                              <div class="col-12">
                                <div id="openapi-ui-spec{{subData?.id}}" class="openapi-spec mt-2"></div>
                              </div>
                            </div>
                          </ng-template>
                          <div class="gradientback">
                          </div>
                        </div>
                      </div>
                      <span class="text-xs my-2 text-gray-200 flex align-items-center">
                        {{ subData?.task?.message }}
                      </span>
                    </div>
                  </span>

                  <ng-template #commentSpan>
                    <div class="flex flex-row justify-content-between align-items-center w-full">
                      <div class="w-full flex justify-content-between align-items-center">
                        <p class="my-0 text-gray-200 text-sm font-normal">
                          {{ subData?.comment?.referenceContent?.title }}
                        </p>
                        <div class="flex align-items-center ">
                          <div class="text-xs mr-2 text-orange-500">{{subData.status}}</div>
                          <span *ngFor="let reviewers of data?.reviewers">
                            <p-avatar [label]="getMeUserAvatar(reviewers)" class="text-xs" shape="circle" [style]="{
                              'background-color': '#9c27b0',
                              color: '#ffffff', fontSize: '10px'
                            }"></p-avatar>
                          </span>
                          <i class="pi pi-ellipsis-v text-base mx-1 text-gray-200"
                            (click)="op.toggle($event); $event.stopPropagation()"></i>
                        </div>
                      </div>
                    </div>
                    <div class="py-2 border-bottom-1 pr-4">
                      <div class="flex flex-row justify-content-between">
                        <div class="sctions-grid  w-full">
                          <div
                            *ngIf="checktableJsonSection(subData?.comment?.referenceContent?.title) else normalCommentView">
                            <pre *ngIf="!subData?.comment?.referenceContent?.showTable"
                              [innerHTML]="subData?.comment?.referenceContent?.content | json"
                              style=" white-space: pre-wrap; overflow: auto"></pre>
                            <xnode-common-spec-table *ngIf="subData?.comment?.referenceContent?.showTable"
                              [specItem]="subData?.comment?.referenceContent?.content?.content"
                              [content]="subData?.comment?.referenceContent?.content"></xnode-common-spec-table>
                          </div>
                          <ng-template #normalCommentView>

                            <div
                              *ngIf="checkParaViewSections(subData?.comment?.referenceContent?.title,subData?.comment?.referenceContent?.parentTitle)"
                              class="h-auto">
                              <xnode-para-view [showComments]="false"
                                [content]="subData?.comment?.referenceContent?.content"
                                [searchTerm]="subData?.comment?.referenceContent?.commentedtext" [users]="usersList"
                                [specItem]="subData?.comment?.referenceContent?.content"
                                [id]="subData?.comment?.referenceContent?.id"></xnode-para-view>
                            </div>
                            <div *ngIf="checkListViewSections(subData?.comment?.referenceContent?.parentTitle)"
                              class="h-auto">
                              <xnode-list-view [content]="subData?.comment?.referenceContent"
                                [searchTerm]="subData?.comment?.referenceContent?.commentedtext"
                                [users]="usersList"></xnode-list-view>
                            </div>
                            <div *ngIf="checkUserRoleSections(subData?.comment?.referenceContent?.parentTitle)"
                              class="h-auto">
                              <xnode-user-roles [searchTerm]="subData?.comment?.referenceContent?.commentedtext"
                                [content]="subData?.comment?.referenceContent" [users]="usersList"
                                [specItem]="subData?.comment?.referenceContent?.content"></xnode-user-roles>
                            </div>
                            <div *ngIf="checkUserPersonaSections(subData?.comment?.referenceContent?.title)"
                              class="h-auto">
                              <xnode-user-persona [searchTerm]="subData?.comment?.referenceContent?.commentedtext"
                                [content]="subData?.comment?.referenceContent?.content"></xnode-user-persona>
                            </div>
                            <div *ngIf="subData?.comment?.referenceContent.title === 'Dashboards'">
                              <div class="flex justify-content-between align-items-center">
                                <h1 class="my-1">Dashboard</h1>
                              </div>
                              <div class="grid">
                                <iframe id="myIframe" [src]="iframeSrc" class="h-vh w-full" title="Template Builder">
                                </iframe>
                              </div>
                            </div>
                            <div
                              *ngIf="subData?.comment?.referenceContent?.title=='Data Quality Checks' || subData?.comment?.referenceContent?.title=='Historical Data Load'|| subData?.comment?.referenceContent?.title == 'Version Control'|| subData?.comment?.referenceContent?.title == 'Stakeholder Approvals' || subData?.comment?.referenceContent?.title=='Glossary'">
                              <xnode-common-spec-table [users]="usersList"
                                [searchTerm]="subData?.comment?.referenceContent?.commentedtext"
                                [content]="subData?.comment?.referenceContent?.content"></xnode-common-spec-table>
                            </div>
                            <div *ngIf="subData?.comment?.referenceContent?.title=='Test Cases'">
                              <div *ngFor="let itemuc of subData?.comment?.referenceContent?.content">
                                <div class="mt-2">
                                  <h3>
                                    {{itemuc.Usecase}}
                                  </h3>
                                  <div class="mt-2">
                                    <xnode-common-spec-table
                                      [searchTerm]="subData?.comment?.referenceContent?.commentedtext"
                                      [users]="usersList" [content]="itemuc.TestCases"></xnode-common-spec-table>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div *ngIf="subData?.comment?.referenceContent?.title==='Workflows'">
                              <xnode-bpmn-common [bpmnFrom]="bpmnFrom" [referenceId]="subData?.comment?.id"
                                [item]="subData?.comment?.referenceContent"></xnode-bpmn-common>
                            </div>
                            <div *ngIf="subData?.comment?.referenceContent?.title==='Data Model'">
                              <xnode-data-model-common
                                [dataModelData]="subData?.comment?.referenceContent"></xnode-data-model-common>
                            </div>
                            <div
                              *ngIf="subData?.comment?.referenceContent?.title === 'Usecases' || subData?.comment?.referenceContent?.title === 'Use Cases'">
                              <xnode-common-usecases [searchTerm]="subData?.comment?.referenceContent?.commentedtext"
                                [users]="usersList"
                                [useCases]="subData?.comment?.referenceContent.content"></xnode-common-usecases>
                            </div>
                            <div *ngIf="subData?.comment?.referenceContent.title === 'OpenAPI Spec'">
                              <div class="flex col-12 justify-content-between align-items-center">
                                <h4 class="m-0">Swagger API</h4>
                              </div>
                              <div class="col-12">
                                <div id="openapi-ui-spec{{subData?.id}}" class="openapi-spec mt-2"></div>
                              </div>
                            </div>
                          </ng-template>
                          <div class="gradientback">
                          </div>
                        </div>
                      </div>
                      <span class="text-xs my-2 text-gray-200 flex align-items-center">
                        {{ subData?.comment?.message }}
                      </span>
                    </div>
                  </ng-template>

                </div>
              </div>
            </ng-template>
          </p-accordionTab>
        </p-accordion>
      </div>
    </div>

    <p-overlayPanel #op>
      <div class="card p-0 m-0" *ngFor="let action of crActions">
        <div class="flex align-items-center border-bottom-1 border-600 pointer pl-2 p-0 m-0"
          (click)="updateChagneRequestStatus(action.label); op.toggle(false)">
          <i class="pi pi-check border-circle flex justify-content-center align-items-center text-xs" [ngClass]="{
            'bg-green-500': action.value === 'SUBMIT' || action.value === 'APPROVE'|| action.value === 'PUBLISH_APP',
            'bg-red-500': action.value === 'ARCHIVE' || action.value === 'REJECT',
            'bg-orange-500': action.value === 'UPDATE' || action.value ==='REVIEW' || action.value ==='NEEDS_WORK',
            'border-yellow-500': action.value === 'DRAFT'}" [ngStyle]="{ 'padding': '3px' }"></i>
          <p class="text-sm font-normal ml-1" [ngClass]="{
            'text-green-500': action.value === 'SUBMIT' || action.value === 'APPROVE'|| action.value === 'PUBLISH_APP',
            'text-red-500': action.value === 'ARCHIVE' || action.value === 'REJECT',
            'text-orange-500': action.value === 'UPDATE' || action.value ==='REVIEW' || action.value ==='NEEDS_WORK',
            'text-yellow-500': action.value === 'DRAFT'}">
            {{action.label}}
          </p>

        </div>
      </div>
    </p-overlayPanel>
  </div>
</div>
<xnode-confirmation-popup-new [header]="header" [content]="content"
  [visible]="openConfirmationPopUp || updateSpecBtnTriggered"
  (onClickAction)="onClickAction($event)"></xnode-confirmation-popup-new>
<xnode-create-new-cr-version *ngIf="showNewCrPopup" [visible]="showNewCrPopup" header="Add New CR" [versions]="[]"
  (close)="showNewCrPopup = false;">
</xnode-create-new-cr-version>

<xnode-limit-reached-popup *ngIf="showLimitReachedPopup" [visible]="showLimitReachedPopup" [limitReachedContent]="true"
  (closePopup)="this.showLimitReachedPopup = false;"></xnode-limit-reached-popup>